

<h1>Outstream Advertising</h1>
<div style="width:800px;height: auto;margin: 0 auto;">
<p>This demo resembles a long blog post with an inline video ad. Scroll down to see the demo and JavaScript code.</p>

<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p>

<p>Donec eget urna sit amet tellus varius efficitur ac sodales lorem. Nullam id elit eros. Etiam finibus nunc vel ante condimentum, eu ullamcorper lorem commodo. Maecenas pretium, nulla id iaculis convallis, lectus dui feugiat arcu, sit amet placerat augue turpis quis ante. Sed sit amet ornare dui. Ut maximus suscipit dictum. Fusce vitae justo tortor. Cras ac vestibulum augue, sed tristique felis. Nam tincidunt sapien velit, dignissim tempus justo laoreet in.</p>

<script type="text/javascript" id='rh-outstream-ad'>
    var thisOutstreamScript = document.getElementById('rh-outstream-ad'),
        playerInstance = {},
        playerHeight,
        playerOffsetTop,
        isScrollTimeout = false;
        adEl = {},
        adLabelEl = {},
        adMediaContainerEl = {},
        advertisingText = '',
        adTag = 'https://vid.springserve.com/vast/352810?w=__player-width__&h=__player-height__&url=__page-url__&cb=__random-number__',        
        afterOutstreamEnabled = true,
        afterOutstreamDisplayAdPubId = 'ca-pub-2928396742559401',
        afterOutstreamDisplayAdSlot = 'adx250',
        afterOutstreamDisplayAdWidth = 300,
        afterOutstreamDisplayAdHeight = 250;   

    // math functions related to scroll and offset positions relative to player
    var getScrollTop = function() {
      var documentEl = document.documentElement;
      return (window.pageYOffset || documentEl.scrollTop) - (documentEl.clientTop || 0);
    };
    var getElementOffsetTop = function(el) {
      var bodyRect = document.body.getBoundingClientRect(),
        elRect = el.getBoundingClientRect();
      return elRect.top - bodyRect.top;
    };
    var getAdInView = function() {
      var scrollBoundary = playerOffsetTop + (playerHeight / 2),
        scrollTop = getScrollTop();
      return (window.innerHeight + scrollTop) > scrollBoundary && scrollTop < scrollBoundary;
    };    

    // cross-browser event binding method
    var setEventListener = function(el, ev, fn) {
      var eventMethod = window.addEventListener ? 'addEventListener' : 'attachEvent',
        eventName = window.addEventListener ? ev : 'on' + ev;
      el[eventMethod](eventName, fn, false);
    };

    // get element margin top and bottom totat height
    var getMarginHeight = function(el) {
      if (document.all) {
        return parseInt(el.currentStyle.marginTop, 10) + parseInt(el.currentStyle.marginBottom, 10);
      } else {
        return parseInt(document.defaultView.getComputedStyle(el, '').getPropertyValue('margin-top')) + parseInt(document.defaultView.getComputedStyle(el, '').getPropertyValue('margin-bottom'));
      }
    };

    // check if ad is in view, ad visible class when necessary (but only the first time it's in view)
    var setAdDisplayState = function() {
      if (getAdInView()) {
        if (!new RegExp('(^| )jw-ad-visible( |$)', 'gi').test(adEl.className)) {
          adEl.className += (adEl.className ? ' ' : '') + 'jw-ad-visible';
          //adEl.style.maxHeight = adLabelEl.offsetHeight + getMarginHeight(adLabelEl) + adMediaContainerEl.offsetHeight + getMarginHeight(adMediaContainerEl) + 'px';
        }
        if (playerInstance.getState() === 'idle' || playerInstance.getState() === 'paused') {
          setTimeout(function() {
            playerInstance.play();
          }, 0);
        }
      } else {
        if (playerInstance.getState() === 'playing') {
          setTimeout(function() {
            playerInstance.pause();
          }, 0);
        }
      }
    }; 

    function appendJWDiv(){
      adEl= document.createElement('div');
      adEl.classList.add('jw-ad');
      adEl.align = 'center';
      thisOutstreamScript.parentElement.insertBefore(adEl,thisOutstreamScript);

      adLabelEl= document.createElement('div');
      adLabelEl.classList.add('jw-ad-label');
      adLabelEl.innerHTML = advertisingText;
      adEl.appendChild(adLabelEl);

      adMediaContainerEl= document.createElement('div');
      adMediaContainerEl.classList.add('jw-ad-media-container');
      adEl.appendChild(adMediaContainerEl);

      var playerEl= document.createElement('div');
      playerEl.id = 'player';
      adMediaContainerEl.appendChild(playerEl);
    }

    function addAfterOutstreamAd(){
      if(!afterOutstreamEnabled) return;
      displayAdContainer= document.createElement('ins');
      displayAdContainer.classList.add('adsbygoogle');
      displayAdContainer.style = 'display:inline-block;width:'+afterOutstreamDisplayAdWidth+'px;height:'+afterOutstreamDisplayAdHeight+'px';
      displayAdContainer.dataset.adClient = afterOutstreamDisplayAdPubId;
      displayAdContainer.dataset.adSlot = afterOutstreamDisplayAdSlot;
      adEl.appendChild(displayAdContainer);

      var adxScript = document.createElement('script');
      adxScript.type = 'text/javascript';   
      adxScript.async = true;
      adxScript.onload = function(){(adsbygoogle = window.adsbygoogle || []).push({});}; 
      adxScript.src = '//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js'; 
      document.body.appendChild(adxScript);
    }

    function cacheBusterTag(tag){
      var random = Math.floor((Math.random() * 10000000));
      return tag.replace('correlator=','correlator='+random);
    }

    function onLoadJWPlayerScript(){
      playerInstance = jwplayer('player');

      // get player container height
      playerHeight = adMediaContainerEl.offsetHeight;
      playerOffsetTop = getElementOffsetTop(adEl);

      playerInstance.setup({
                          advertising: {
                                outstream: true,
                                client: 'googima',
                                autostart: true, 
                                mute: true, 
                                tag: cacheBusterTag(adTag)
                            }
                      });
      playerInstance.pause();

      // handle ad display state on page load
      setTimeout(setAdDisplayState(), 1000);

       // attach scroll event listener to window
      setEventListener(window, 'scroll', function() {
          // skip if we're waiting on a scroll update timeout to finish
          if (isScrollTimeout) return;
          // flag that a new timeout will begin
          isScrollTimeout = true;
          // otherwise, execute scroll event handler
          setAdDisplayState();
          // set new timeout
          setTimeout(function() {
            // reset timeout flag to false (no longer waiting)
            isScrollTimeout = false;
          }, 100);
      });

      playerInstance.on('complete adComplete adError', function(e) {
        adEl.style.transition = 'all 0.5s ease';
        //adEl.style.maxHeight = '0px';
        try{
          playerInstance.remove();
        } catch(e){
          console.log('Some error occured');
        }
        
        adMediaContainerEl.parentNode.removeChild(adMediaContainerEl);

        addAfterOutstreamAd();
      });

    }

    !function(){
      if(!thisOutstreamScript){
        var scripts = document.getElementsByTagName('script')
        for (var i = 0; i < scripts.length; ++i) {
            if( scripts[i].innerText.indexOf('thisOutstreamScript') >= 0){
              thisOutstreamScript = scripts[i];
            }
        }
      }
      appendJWDiv();
      var jwPlayerScript = document.createElement('script');
      jwPlayerScript.type = 'text/javascript';   
      jwPlayerScript.onload = onLoadJWPlayerScript; 
      jwPlayerScript.src = '//content.jwplatform.com/libraries/8ceoQAzG.js'; 
      document.body.appendChild(jwPlayerScript);
    }();          
</script>

<p>Vivamus eleifend congue lectus, quis ullamcorper tortor accumsan non. Duis vitae mattis tortor. Nulla vitae odio enim. Praesent eu orci at elit venenatis luctus. Praesent at luctus mauris. Maecenas accumsan posuere varius. Suspendisse id vehicula mauris. Vestibulum id neque vitae dui lobortis eleifend non sed erat. Nunc posuere augue nec turpis ornare facilisis. Vivamus lectus justo, commodo sed molestie consequat, dictum sed est. Maecenas semper velit placerat ex finibus rhoncus. Duis nisi justo, pharetra ac ipsum ac, gravida venenatis risus. Praesent eu est ultrices, lobortis felis quis, volutpat augue. Mauris non varius lacus. Etiam pulvinar ornare lectus et tristique.</p>

<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque dui ex, suscipit eu ultrices et, congue nec quam. Sed ultricies bibendum quam at sollicitudin. Mauris ut dapibus sapien. Sed turpis mauris, cursus in enim ut, sodales tempus tortor. Donec varius aliquam massa. Donec fermentum pellentesque molestie. Integer varius porta vehicula. Etiam volutpat nibh et nisl malesuada, vel auctor tellus commodo. Aliquam quis pharetra diam. Aliquam efficitur molestie viverra. Curabitur eu vulputate odio. Praesent sollicitudin tincidunt rhoncus. Phasellus nunc metus, blandit quis arcu at, feugiat viverra lorem. Phasellus sollicitudin augue at tincidunt ullamcorper. Quisque non ipsum augue.</p>

<p>Donec eget urna sit amet tellus varius efficitur ac sodales lorem. Nullam id elit eros. Etiam finibus nunc vel ante condimentum, eu ullamcorper lorem commodo. Maecenas pretium, nulla id iaculis convallis, lectus dui feugiat arcu, sit amet placerat augue turpis quis ante. Sed sit amet ornare dui. Ut maximus suscipit dictum. Fusce vitae justo tortor. Cras ac vestibulum augue, sed tristique felis. Nam tincidunt sapien velit, dignissim tempus justo laoreet in.</p>
</div>
